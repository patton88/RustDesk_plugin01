name: "RustDesk Plugin Build - æœ€ç»ˆç‰ˆæœ¬"
on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æ„å»ºç±»å‹'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - debug

jobs:
  generate-bridge:
    name: "ç”ŸæˆFlutter Rust Bridgeä»£ç "
    runs-on: ubuntu-latest
    steps:
      - name: "æ£€å‡ºä»£ç "
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "å®‰è£…Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'

      - name: "å…¨æ–°ä¿®å¤Flutterä¾èµ–"
        run: |
          echo "=== å¼€å§‹å…¨æ–°ä¿®å¤Flutterä¾èµ– ==="
          cd flutter
          echo "å½“å‰pubspec.yamlå†…å®¹:"
          cat pubspec.yaml
          
          echo "=== å¼ºåˆ¶æ·»åŠ flutter_rust_bridge_codegen ==="
          if ! grep -q "flutter_rust_bridge_codegen" pubspec.yaml; then
            echo "  flutter_rust_bridge_codegen:" >> pubspec.yaml
            echo "    git:" >> pubspec.yaml
            echo "      url: https://github.com/fzyzcjy/flutter_rust_bridge" >> pubspec.yaml
            echo "      path: flutter_rust_bridge_codegen" >> pubspec.yaml
          fi
          
          echo "=== æ¸…ç†Flutterç¼“å­˜ ==="
          flutter clean
          flutter pub cache clean
          
          echo "=== é‡æ–°å®‰è£…ä¾èµ– ==="
          flutter pub get
          
          echo "=== éªŒè¯ä¾èµ–å®‰è£… ==="
          flutter pub deps | grep -i bridge || echo "æœªæ‰¾åˆ°bridgeç›¸å…³ä¾èµ–"
          echo "=== Flutterä¾èµ–ä¿®å¤å®Œæˆ ==="

      - name: "ç”Ÿæˆæ¡¥æ¥ä»£ç "
        run: |
          echo "=== å¼€å§‹ç”Ÿæˆæ¡¥æ¥ä»£ç  ==="
          cd flutter
          
          echo "=== åˆ›å»ºsrc/api.rs ==="
          mkdir -p ../src
          cat > ../src/api.rs << 'EOF'
          use serde::{Deserialize, Serialize};

          #[derive(Debug, Clone, Serialize, Deserialize)]
          pub struct AppInfo {
              pub version: String,
              pub name: String,
          }

          pub fn get_version() -> String {
              env!("CARGO_PKG_VERSION").to_string()
          }

          pub fn app_info_new() -> AppInfo {
              AppInfo {
                  version: get_version(),
                  name: "RustDesk".to_string(),
              }
          }
          EOF
          
          echo "=== è¿è¡Œbuild_runner ==="
          flutter packages pub run build_runner build --delete-conflicting-outputs
          
          echo "=== ç”ŸæˆFlutter Rust Bridgeä»£ç  ==="
          flutter packages pub run flutter_rust_bridge_codegen \
            --rust-input ../src/api.rs \
            --dart-output lib/bridge_generated.dart \
            --rust-output ../src/bridge_generated.rs \
            --class-name RustDeskApi \
            --wasm
          
          echo "=== æ¡¥æ¥ä»£ç ç”Ÿæˆå®Œæˆ ==="
          
          echo "=== éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶ ==="
          ls -la ../src/
          ls -la lib/

      - name: "ä¸Šä¼ æ¡¥æ¥ä»£ç "
        uses: actions/upload-artifact@v4
        with:
          name: bridge-artifact-final
          path: |
            ../src/api.rs
            ../src/bridge_generated.rs
            lib/bridge_generated.dart
            lib/bridge_definitions.dart

  build-windows-plugin:
    name: "æ„å»ºWindowsæ’ä»¶"
    needs: generate-bridge
    runs-on: windows-latest
    steps:
      - name: "æ£€å‡ºä»£ç "
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "ä¸‹è½½æ¡¥æ¥ä»£ç "
        uses: actions/download-artifact@v4
        with:
          name: bridge-artifact-final
          path: .

      - name: "è®¾ç½®LLVMç¯å¢ƒ"
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '2024.12.19'
          vcpkgDirectory: '${{ github.workspace }}/vcpkg_installed'

      - name: "å®‰è£…Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'

      - name: "å®‰è£…Rust"
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: "è®¾ç½®ç¯å¢ƒå˜é‡"
        run: |
          echo "RUSTFLAGS=-C target-feature=+crt-static" >> $env:GITHUB_ENV
          echo "CARGO_NET_GIT_FETCH_WITH_CLI=true" >> $env:GITHUB_ENV

      - name: "æ„å»ºæ’ä»¶"
        run: |
          echo "=== å¼€å§‹æ„å»ºrd_ui_pluginæ’ä»¶ ==="
          cargo build --release --package rd_ui_plugin
          
          echo "=== éªŒè¯æ’ä»¶æ„å»ºç»“æœ ==="
          if (Test-Path "target\release\plugin_rd_ui_plugin.dll") {
              echo "âœ… æ’ä»¶æ„å»ºæˆåŠŸ: target\release\plugin_rd_ui_plugin.dll"
              Get-ChildItem "target\release\plugin_rd_ui_plugin.dll" | Format-List
          } else {
              echo "âŒ æ’ä»¶æ„å»ºå¤±è´¥"
              exit 1
          }

      - name: "æ„å»ºRustDeskä¸»ç¨‹åº"
        run: |
          echo "=== å¼€å§‹æ„å»ºRustDeskä¸»ç¨‹åº ==="
          python build.py --flutter --release
          
          echo "=== éªŒè¯ä¸»ç¨‹åºæ„å»ºç»“æœ ==="
          if (Test-Path "target\release\rustdesk.exe") {
              echo "âœ… ä¸»ç¨‹åºæ„å»ºæˆåŠŸ: target\release\rustdesk.exe"
              Get-ChildItem "target\release\rustdesk.exe" | Format-List
          } else {
              echo "âŒ ä¸»ç¨‹åºæ„å»ºå¤±è´¥"
              exit 1
          }

      - name: "é›†æˆé©±åŠ¨ç¨‹åº"
        run: |
          echo "=== é›†æˆé©±åŠ¨ç¨‹åº ==="
          if (Test-Path "target\release\drivers") {
              echo "âœ… é©±åŠ¨ç¨‹åºç›®å½•å­˜åœ¨"
              Get-ChildItem "target\release\drivers" -Recurse | Format-List
          } else {
              echo "âš ï¸ é©±åŠ¨ç¨‹åºç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          }

      - name: "å¤åˆ¶æ’ä»¶æ–‡ä»¶"
        run: |
          echo "=== å¤åˆ¶æ’ä»¶æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½• ==="
          $pluginDir = "target\release\plugins\rd_ui_plugin"
          New-Item -ItemType Directory -Path $pluginDir -Force
          
          Copy-Item "target\release\plugin_rd_ui_plugin.dll" $pluginDir
          
          echo "=== åˆ›å»ºæ’ä»¶é…ç½®æ–‡ä»¶ ==="
          $configContent = '{"fullscreen": true, "scale": "fit", "toolbar": "hide"}'
          Set-Content -Path "$pluginDir\config.json" -Value $configContent -Encoding UTF8
          
          echo "=== éªŒè¯æ’ä»¶æ–‡ä»¶ ==="
          Get-ChildItem $pluginDir -Recurse | Format-List

      - name: "åˆ›å»ºæ„å»ºä¿¡æ¯"
        run: |
          echo "=== åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶ ==="
          $buildInfo = "RustDesk Plugin Build - æœ€ç»ˆç‰ˆæœ¬`næ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`nGitæäº¤: ${{ github.sha }}`nå·¥ä½œæµ: ${{ github.workflow }}`nåˆ†æ”¯: ${{ github.ref_name }}"
          Set-Content -Path "target\release\BUILD_INFO.txt" -Value $buildInfo -Encoding UTF8

      - name: "æ‰“åŒ…è¾“å‡º"
        run: |
          echo "=== æ‰“åŒ…æ„å»ºè¾“å‡º ==="
          $version = "1.4.1-plugin-final"
          $zipName = "rustdesk-$version-windows-x64.zip"
          
          Compress-Archive -Path "target\release\*" -DestinationPath $zipName -Force
          
          echo "=== éªŒè¯æ‰“åŒ…ç»“æœ ==="
          if (Test-Path $zipName) {
              echo "âœ… æ‰“åŒ…æˆåŠŸ: $zipName"
              Get-ChildItem $zipName | Format-List
          } else {
              echo "âŒ æ‰“åŒ…å¤±è´¥"
              exit 1
          }

      - name: "ä¸Šä¼ æ„å»ºäº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-plugin-final-${{ github.run_number }}
          path: |
            target/release/
            *.zip
          retention-days: 30

      - name: "æ„å»ºå®Œæˆé€šçŸ¥"
        run: |
          echo "ğŸ‰ RustDeskæ’ä»¶æ„å»ºå®Œæˆï¼"
          echo "ğŸ“¦ æ„å»ºäº§ç‰©: rustdesk-plugin-final-${{ github.run_number }}"
          echo "ğŸ”Œ æ’ä»¶æ–‡ä»¶: target\release\plugins\rd_ui_plugin\"
          echo "ğŸš€ ä¸»ç¨‹åº: target\release\rustdesk.exe"
